# ~~ Generated by projen. To modify, edit .projenrc.ts and run "pnpm dlx projen".

name: cicd-release-quality
on:
  push:
    branches:
      - main
jobs:
  test-back-end:
    name: Test Back-End
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    environment: quality
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ENV_TYPE: ${{ vars.ENV_TYPE }}
      ENV_NAME: ${{ vars.ENV_NAME }}
      APPLICATION_URL: ${{ vars.APPLICATION_URL }}
      SYSTEM_ADMIN_EMAIL: ${{ vars.SYSTEM_ADMIN_EMAIL }}
      AWS_HOSTED_ZONE_ID: ${{ secrets.AWS_HOSTED_ZONE_ID }}
      AWS_HOSTED_ZONE_NAME: ${{ secrets.AWS_HOSTED_ZONE_NAME }}
      AWS_CERTIFICATE_ARN: ${{ secrets.AWS_CERTIFICATE_ARN }}
      AWS_COGNITO_USER_POOL_ID: ${{ secrets.AWS_COGNITO_USER_POOL_ID }}
      AWS_COGNITO_CLIENT_ID: ${{ secrets.AWS_COGNITO_CLIENT_ID }}
      AWS_BASE_API_URL: ${{ secrets.AWS_BASE_API_URL }}
      MOCK_ORG_ID: ${{ vars.MOCK_ORG_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install pnpm
        uses: pnpm/action-setup@v2.2.1
        with:
          version: 8.6.0
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18.16.0
          cache: pnpm
      - name: Nx cache
        uses: actions/cache@v3
        with:
          path: node_modules/.cache/nx
          fail-on-cache-miss: false
          key: nx-${{ github.repository_id }}-${{ github.sha }}
      - name: Install dependencies
        run: pnpm install
      - name: Derive SHAs for nx affected commands
        uses: nrwl/nx-set-shas@v2
        with:
          main-branch-name: main
      - name: Run Test Back-End CI/CD
        run: pnpm cicd-test-back-end
  build-deploy-back-end:
    name: Build & Deploy Back-End
    needs: test-back-end
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      actions: read
    environment: quality
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ENV_TYPE: ${{ vars.ENV_TYPE }}
      ENV_NAME: ${{ vars.ENV_NAME }}
      APPLICATION_URL: ${{ vars.APPLICATION_URL }}
      SYSTEM_ADMIN_EMAIL: ${{ vars.SYSTEM_ADMIN_EMAIL }}
      AWS_HOSTED_ZONE_ID: ${{ secrets.AWS_HOSTED_ZONE_ID }}
      AWS_HOSTED_ZONE_NAME: ${{ secrets.AWS_HOSTED_ZONE_NAME }}
      AWS_CERTIFICATE_ARN: ${{ secrets.AWS_CERTIFICATE_ARN }}
      AWS_COGNITO_USER_POOL_ID: ${{ secrets.AWS_COGNITO_USER_POOL_ID }}
      AWS_COGNITO_CLIENT_ID: ${{ secrets.AWS_COGNITO_CLIENT_ID }}
      AWS_BASE_API_URL: ${{ secrets.AWS_BASE_API_URL }}
      MOCK_ORG_ID: ${{ vars.MOCK_ORG_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install pnpm
        uses: pnpm/action-setup@v2.2.1
        with:
          version: 8.6.0
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18.16.0
          cache: pnpm
      - name: Nx cache
        uses: actions/cache@v3
        with:
          path: node_modules/.cache/nx
          fail-on-cache-miss: false
          key: nx-${{ github.repository_id }}-${{ github.sha }}
      - name: Install dependencies
        run: pnpm install
      - name: Derive SHAs for nx affected commands
        uses: nrwl/nx-set-shas@v2
        with:
          main-branch-name: main
      - name: Configure AWS Credentials
        id: configure_iam_credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::851725267090:role/GitHub_to_AWS_via_FederatedOIDC
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          role-duration-seconds: 3600
          aws-region: ap-southeast-1
          audience: sts.amazonaws.com
      - name: Run Build & Deploy Back-End CI/CD
        run: pnpm cicd-build-deploy-back-end
  test-front-end:
    name: Test Front-End
    needs: build-deploy-back-end
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    environment: quality
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ENV_TYPE: ${{ vars.ENV_TYPE }}
      ENV_NAME: ${{ vars.ENV_NAME }}
      APPLICATION_URL: ${{ vars.APPLICATION_URL }}
      SYSTEM_ADMIN_EMAIL: ${{ vars.SYSTEM_ADMIN_EMAIL }}
      AWS_HOSTED_ZONE_ID: ${{ secrets.AWS_HOSTED_ZONE_ID }}
      AWS_HOSTED_ZONE_NAME: ${{ secrets.AWS_HOSTED_ZONE_NAME }}
      AWS_CERTIFICATE_ARN: ${{ secrets.AWS_CERTIFICATE_ARN }}
      AWS_COGNITO_USER_POOL_ID: ${{ secrets.AWS_COGNITO_USER_POOL_ID }}
      AWS_COGNITO_CLIENT_ID: ${{ secrets.AWS_COGNITO_CLIENT_ID }}
      AWS_BASE_API_URL: ${{ secrets.AWS_BASE_API_URL }}
      MOCK_ORG_ID: ${{ vars.MOCK_ORG_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install pnpm
        uses: pnpm/action-setup@v2.2.1
        with:
          version: 8.6.0
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18.16.0
          cache: pnpm
      - name: Nx cache
        uses: actions/cache@v3
        with:
          path: node_modules/.cache/nx
          fail-on-cache-miss: false
          key: nx-${{ github.repository_id }}-${{ github.sha }}
      - name: Install dependencies
        run: pnpm install
      - name: Derive SHAs for nx affected commands
        uses: nrwl/nx-set-shas@v2
        with:
          main-branch-name: main
      - name: Run Test Front-End CI/CD
        run: pnpm cicd-test-front-end
  build-deploy-front-end:
    name: Build & Deploy Front-End
    needs: test-front-end
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      actions: read
    environment: quality
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ENV_TYPE: ${{ vars.ENV_TYPE }}
      ENV_NAME: ${{ vars.ENV_NAME }}
      APPLICATION_URL: ${{ vars.APPLICATION_URL }}
      SYSTEM_ADMIN_EMAIL: ${{ vars.SYSTEM_ADMIN_EMAIL }}
      AWS_HOSTED_ZONE_ID: ${{ secrets.AWS_HOSTED_ZONE_ID }}
      AWS_HOSTED_ZONE_NAME: ${{ secrets.AWS_HOSTED_ZONE_NAME }}
      AWS_CERTIFICATE_ARN: ${{ secrets.AWS_CERTIFICATE_ARN }}
      AWS_COGNITO_USER_POOL_ID: ${{ secrets.AWS_COGNITO_USER_POOL_ID }}
      AWS_COGNITO_CLIENT_ID: ${{ secrets.AWS_COGNITO_CLIENT_ID }}
      AWS_BASE_API_URL: ${{ secrets.AWS_BASE_API_URL }}
      MOCK_ORG_ID: ${{ vars.MOCK_ORG_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install pnpm
        uses: pnpm/action-setup@v2.2.1
        with:
          version: 8.6.0
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18.16.0
          cache: pnpm
      - name: Nx cache
        uses: actions/cache@v3
        with:
          path: node_modules/.cache/nx
          fail-on-cache-miss: false
          key: nx-${{ github.repository_id }}-${{ github.sha }}
      - name: Install dependencies
        run: pnpm install
      - name: Derive SHAs for nx affected commands
        uses: nrwl/nx-set-shas@v2
        with:
          main-branch-name: main
      - name: Configure AWS Credentials
        id: configure_iam_credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::851725267090:role/GitHub_to_AWS_via_FederatedOIDC
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          role-duration-seconds: 3600
          aws-region: ap-southeast-1
          audience: sts.amazonaws.com
      - name: Run Build & Deploy Front-End CI/CD
        run: pnpm cicd-build-deploy-front-end
